/*
    This is the skeleton job for integration builds of
    individual branches.  It is installed by the setup job.
*/

def sourceRepository = "$GH_ORGANIZATION_NAME/$GH_REPO_NAME"


/*
    Definition for a job to check out and build a specific branch.
*/
job("${FOLDER_NAME}/_lower/Integration build for $BRANCH on $ENVIRONMENT") {

  wrappers {
    credentialsBinding {
      string('GITHUB_TOKEN', GH_USER_TOKEN_KEY)
      usernamePassword('NEXUS_USER', 'NEXUS_PASS', NEXUS_USER_KEY)
      file( 'SUBSTITUTION_FILE', CONFIG_SUBSTITUTIONS)
    }

    environmentVariables {
      envs (
        GH_ORGANIZATION_NAME : GH_ORGANIZATION_NAME,
        GH_REPO_NAME : GH_REPO_NAME,
        BRANCH_NAME : BRANCH,
        ENVIRONMENT : ENVIRONMENT
      )
    }
  }

  // Once an hour, check GitHub to see if there have been any changes
  // and if so, schedule a build.
  triggers {
    pollSCM {
      scmpoll_spec("H 7-19 * * 1-5")
    }
  }

  label("wcms-${ENVIRONMENT}") // Require the specific build environment.

  scm {
    git {
      remote {
        name('origin')
        url("https://github.com/$sourceRepository")
      }
      branch("*/$TARGET_BRANCH")
      extensions {
        submoduleOptions {
          recursive(true)
        }
      }
    }
  }

  steps {
    batchFile("call \"%WORKSPACE%\\tools\\build\\integration-build.bat\" %BRANCH_NAME% %ENVIRONMENT%")
  }
}